{% extends "base.html" %}

{% block title %}Subjects - Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-book me-2"></i>Subjects Management</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#subjectModal">
                <i class="fas fa-plus me-2"></i>Add Subject
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Subject Code</th>
                        <th>Subject Name</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for subject in subjects %}
                    <tr>
                        <td>{{ subject.code }}</td>
                        <td>{{ subject.name }}</td>
                        <td>{{ subject.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editSubject({{ subject.id }}, '{{ subject.code }}', '{{ subject.name }}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSubject({{ subject.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Subject Modal -->
<div class="modal fade" id="subjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="subjectModalTitle">Add Subject</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="subjectForm">
                    <input type="hidden" id="subjectId">
                    <div class="mb-3">
                        <label for="subjectCode" class="form-label">Subject Code</label>
                        <input type="text" class="form-control" id="subjectCode" required>
                    </div>
                    <div class="mb-3">
                        <label for="subjectName" class="form-label">Subject Name</label>
                        <input type="text" class="form-control" id="subjectName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSubject()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingSubjectId = null;

function editSubject(id, code, name) {
    editingSubjectId = id;
    document.getElementById('subjectModalTitle').textContent = 'Edit Subject';
    document.getElementById('subjectId').value = id;
    document.getElementById('subjectCode').value = code;
    document.getElementById('subjectName').value = name;
    new bootstrap.Modal(document.getElementById('subjectModal')).show();
}

function saveSubject() {
    const data = {
        code: document.getElementById('subjectCode').value,
        name: document.getElementById('subjectName').value
    };
    
    const url = editingSubjectId ? `/api/subjects/${editingSubjectId}` : '/api/subjects';
    const method = editingSubjectId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(() => {
        location.reload();
    })
    .catch(error => alert('Error: ' + error));
}

function deleteSubject(id) {
    if (confirm('Are you sure you want to delete this subject?')) {
        fetch(`/api/subjects/${id}`, {method: 'DELETE'})
        .then(() => location.reload())
        .catch(error => alert('Error: ' + error));
    }
}

// Reset modal on close
document.getElementById('subjectModal').addEventListener('hidden.bs.modal', function () {
    editingSubjectId = null;
    document.getElementById('subjectModalTitle').textContent = 'Add Subject';
    document.getElementById('subjectForm').reset();
});
</script>
{% endblock %}